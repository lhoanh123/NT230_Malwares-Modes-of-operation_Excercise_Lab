---------------------------------------------------------
                    README.TXT 
---------------------------------------------------------

Thông tin sinh viên:
- Họ và tên: Lê Hoàng Oanh
- MSSV: 21521253
- Lớp : Cơ chế hoạt động của mã độc - NT230.O22.ATCL

---------------------------------------------------------
                        Đề bài
---------------------------------------------------------

Đề bài: Viết 01 chương trình Python/C++/C# có khả năng:
- Thêm mới 1 section vào sau section cuối cùng của file PE bất kỳ, trong đó:
 + Đầu vào: tên của section, code thực thi được ghi vào section mới này.
 + Đầu ra: file PE sau khi thêm section
- Thay đổi entrypoint của chương trình nhằm:
 + Hiển thị một thông điệp chào mừng trước khi code của ứng dụng chạy

---------------------------------------------------------
                    Thông tin cơ bản
---------------------------------------------------------
Program.cs:
- Ngôn ngữ lập trình: C#
- Framework: .NET
- Thư viện sử dụng: AsmResolver library
- Hệ điều hành: Windows
- Công cụ: Visual Studio hoặc bất kỳ trình biên dịch C# nào tương thích

example.cpp:
- Ngôn ngữ lập trình: C++
- Thư viện sử dụng: Windows API
- Hệ điều hành: Windows
- Công cụ: Visual Studio Code hoặc bất kỳ trình biên dịch C++ nào tương thích

---------------------------------------------------------
                    Mô tả chi tiết
---------------------------------------------------------

1. Main(): Đây là hàm chính của chương trình. Nó là nơi bắt đầu khi chương trình được chạy. Trong hàm này:
- Chương trình nhập đường dẫn của tập tin exe và tên của phần mới được thêm vào.
- Sau đó, nó đọc tập tin exe và hình ảnh PE.
- Tiếp theo, chương trình thêm mã mới vào phần đã chỉ định, cập nhật địa chỉ của điểm nhập (entry point), thêm các trampoline, xây dựng lại bảng IAT và relocs, và cuối cùng ghi tập tin đã sửa đổi ra một đường dẫn mới.

2. GetOutputFilePath(): Hàm này được sử dụng để tạo ra đường dẫn mới cho tập tin được sửa đổi bằng cách thay đổi phần mở rộng của tập tin.

3. InjectNewCode(): Hàm này thêm mã mới vào tập tin PE. 
- Thực hiện Import Hàm từ DLL bên ngoài: Đầu tiên, chúng ta cần import một hàm từ một DLL bên ngoài vào hình ảnh PE của chương trình. Trong ví dụ này, hàm puts() được import từ thư viện ucrtbase.dll. Điều này được thực hiện bằng cách tạo một ImportedModule và một ImportedSymbol tương ứng, sau đó thêm chúng vào PEImage của tập tin.

- Định nghĩa một entry point symbol: Chúng ta cần định nghĩa một biểu tượng (symbol) cho điểm nhập (entry point) của chương trình để có thể tham chiếu sau này trong mã. Điều này cần thiết để có thể chuyển hướng thực thi từ mã mới về mã gốc của chương trình.

- Tạo Segment Mới Chứa Mã Mới: Tiếp theo, chúng ta tạo một segment mới chứa mã mới được cung cấp. Đầu tiên, chúng ta xác định kiến trúc của máy (32-bit hoặc 64-bit) và sử dụng các hàm tạo mã phù hợp (CreateI386CodeSegment cho 32-bit và CreateAmd64CodeSegment cho 64-bit).

- Thêm Segment và Relocations vào PEFile: 
    + Sau khi tạo segment mới và các relocation tương ứng, chúng ta thêm segment này vào một phần mới trong tập tin PE, được chỉ định bởi tên phần sectionName.
    + Đồng thời, chúng ta cũng thêm tất cả các relocation của segment vào bảng relocation của tập tin PE.

4. CreateI386CodeSegment() và CreateAmd64CodeSegment(): Đây là hai hàm tạo segment mã cho kiến trúc 32-bit và 64-bit. Hàm này xác định cách patch các tham chiếu tương đối và tuyệt đối trong mã.
- Tạo một segment dữ liệu từ mã được cung cấp.
- Patch các tham chiếu trong mã để chỉ định địa chỉ của hàm puts() và điểm nhập gốc của chương trình.
- Tạo các relocation tương ứng cho các tham chiếu cần được di chuyển.

5. InjectTrampolines(): Hàm này tạo ra các trampoline (nhảy trung gian) cho các hàm được import vào tập tin. Mỗi trampoline đảm bảo rằng các hàm gốc được gọi thông qua IAT (Import Address Table) sẽ được chuyển hướng đến trampoline, và từ đó chuyển hướng đến hàm thực sự.

6. RebuildIatAndRelocs(): Hàm này tái tạo bảng IAT và relocs sau khi mã mới đã được thêm vào. Nó cũng tính toán lại offsets và cập nhật headers của tập tin PE.

---------------------------------------------------------
                Thực thi chương trình
---------------------------------------------------------
Trước tiên, ta thay đổi đường dẫn của file exe. Trong thư mục có một file example.cpp, có thể chạy và lấy ra file .exe. Có thể thay đổi thông báo in ra bằng cách thay đổi biến code ở hàm Main theo đúng định dạng. 

1. Chương trình bắt đầu bằng việc đọc tập tin exe và PE image của nó.

2. Sau đó, nó chèn mã máy mới vào một phần được chỉ định của tập tin exe.

3. Các trampoline sau đó được chèn vào để gọi các hàm từ các thư viện DLL.

4. Bảng IAT và relocs được xây dựng lại và cập nhật.

5. Cuối cùng, tập tin exe mới được ghi ra đường dẫn mới.

---------------------------------------------------------
